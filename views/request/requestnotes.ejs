<link rel="stylesheet" href="/css/requestnotes.css">

<section class="request-notes-section">
  <div class="container">
    <h1>ðŸ“¢ Request Notes</h1>
    
    <!-- Desktop Form -->
    <form action="/requestnotes" method="POST" class="request-form">
      <textarea name="content" placeholder="Request notes from your peers..." maxlength="280" required></textarea>
      <button type="submit">Post</button>
    </form>

    <!-- Floating Action Button for Mobile -->
    <div class="fab" onclick="document.querySelector('.request-form').style.display='flex'">+</div>

    <!-- Feed -->
    <div class="requests-feed">
      <% if (requests && requests.length) { %>
        <% requests.forEach(request => { %>
          <div class="request-card">
            <div class="request-user">
              <img src="<%= request.user.avatar || '/images/dummy_profile.avif' %>" alt="User Avatar">
              <div>
                <h4><%= request.user.name || request.user.username %></h4>
                <span class="timestamp"><%= request.createdAt.toLocaleString() %></span>
              </div>
            </div>

            <p class="request-content"><%= request.content %></p>

            <!-- Delete button -->
            <% if (currUser && (currUser._id.equals(request.user._id) || currUser.role === "moderator")) { %>
              <form action="/requestnotes/<%= request._id %>/delete" method="POST" onsubmit="return confirm('Delete this request?')">
                <button type="submit" class="delete-btn">ðŸ—‘ Delete</button>
              </form>
            <% } %>

            <!-- Comments Section -->
            <div class="comments-section">
              <% if (request.comments && request.comments.length) { %>
                <% request.comments.forEach(comment => { %>
                  <div class="comment">
                    <a href="/profile/<%= comment.user._id %>" class="comments-username"><strong><%= comment.user.username || comment.user.name %>:</strong></a>
                    <span><%= comment.content %></span>
                    <span class="timestamp"><%= comment.createdAt.toLocaleString() %></span>
                  </div>
                <% }) %>
              <% } else { %>
                <p class="no-comments">No comments yet.</p>
              <% } %>
            </div>

            <!-- Add Comment Form -->
            <% if (currUser) { %>
              <form action="/requestnotes/<%= request._id %>/comment" method="POST" class="comment-form">
                <input type="text" name="content" placeholder="Write a comment..." maxlength="200" required>
                <button type="submit">ðŸ’¬</button>
              </form>
            <% } %>
</div>


        <% }) %>
      <% } else { %>
        <p class="no-requests">No requests yet. Be the first to ask! ðŸš€</p>
      <% } %>
    </div>
  </div>
</section>

<script>
  // Request form validation
  document.querySelector(".request-form").addEventListener("submit", function (e) {
    const textarea = this.querySelector("textarea");
    const content = textarea.value.trim();

    if (!content) {
      alert("Request cannot be empty!");
      e.preventDefault();
      return;
    }

    if (content.length <= 10) {
      alert("Request must be greater than 10 characters!");
      e.preventDefault();
    }

    if (content.length > 280) {
      alert("Request must be 280 characters or less!");
      e.preventDefault();
    }
  });

  // Comment form validation
  document.querySelectorAll(".comment-form").forEach(form => {
    form.addEventListener("submit", function (e) {
      const input = this.querySelector("input[name='content']");
      const content = input.value.trim();

      if (!content) {
        alert("Comment cannot be empty!");
        e.preventDefault();
        return;
      }

      if (content.length > 200) {
        alert("Comment must be 200 characters or less!");
        e.preventDefault();
      }
    });
  });
</script>
